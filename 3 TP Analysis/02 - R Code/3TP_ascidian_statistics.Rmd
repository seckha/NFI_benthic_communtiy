---
title: "3 TP Ascidian statistics"
author: "Shannon Eckhardt"
date: "2023-10-31"
output: html_document
---

Statistics for ascidian cover

# IMPORT LIBRARIES
```{r}
library(readxl) # load data
library(glmmTMB) # for hurdle model
library(emmeans) # for post-hoc analysis
library(lmtest) # for likelihood ratio test
library(DHARMa) # for diagnostics
library(tidyverse)
```

# IMPORT DATA
```{r}
ascd.transect.percent.cover <- read_excel("/Users/Shannon/GitHub/NFI_benthic_community/3 TP Analysis/01 - Data/Ascidian_transect_percent_cover.xlsx")

full_data <- read_excel("/Users/Shannon/GitHub/NFI_benthic_community/3 TP Analysis/01 - Data/FULL_DATA_21_22_23.xlsx")

# transect percent cover
full_dat_transect_percent_cover <- full_data %>%
  group_by(TP, Site, Transect_ID, Category) %>%
  summarize(percent_cover = mean(sum_count)) %>% # mean() already gives a percentage
  mutate(SE = sd(percent_cover) / sqrt(n()))

# make tibble into data frame
full_dat_transect_percent_cover <- as.data.frame(full_dat_transect_percent_cover)
```

# HURDLE MODEL - using glmmTMB
```{r}
# convert percent cover from 0-100 to 0-1
ascd.transect.percent.cover$percent_cover <- ascd.transect.percent.cover$percent_cover / 100

m.hurd <- glmmTMB(percent_cover ~ TP * Site + (1|Transect_ID), ziformula = ~1, data = ascd.transect.percent.cover, family=beta_family())


# diagnostics
simulationOutput <- simulateResiduals(fittedModel = m.hurd, plot = F)
plot(simulationOutput)
```

# ANOVA/LRT - using lmtest
Does ascidian cover significantly vary between site and time point?
```{r}
# Likelihood ratio test (LRT) instead of anova as they are more suited for mixed-effects models and models with non-Gaussian distributions?

# likelihood ratio test for the influence of Site and TP
lrtest_result <- lrtest(m.hurd, ~Site + TP)
print(lrtest_result)
```

# POST-HOC ANALYSIS - using emmeans
```{r}
# calculate marginal means for Site and Time Point
emmeans_results <- emmeans(m.hurd, ~ Site + TP, model = "zero_infl")

# perform pairwise comparisons for sites
site_comparisons <- pairs(emmeans_results, by = "Site")

# perform pairwise comparisons for time points
tp_comparisons <- pairs(emmeans_results, by = "TP")

# perform pairwise comparisons for both Site and TP
site_tp_comparisons <- pairs(emmeans_results, by = NULL)

# summarize the results
summary(site_comparisons)
summary(tp_comparisons)
summary(site_tp_comparisons)
```

# TRY TO DO PCA

after: https://www.youtube.com/watch?v=mNpBrHwOCt4

```{r}
library(MASS)
library(factoextra)
library(ggplot2)

# transpose df
wide.full.dat <- full_dat_transect_percent_cover %>% pivot_wider(names_from = Category, values_from = percent_cover)

str(wide.full.dat) # all relevant variables are numeric
summary(wide.full.dat)

# delete classes with NA
# have no NAs

# exclude categorical data (in 4 four columns)
full.dat.sample <- wide.full.dat[, -c(1:4)]

# run PCA
full.dat.pca <- prcomp(full.dat.sample,
                       scale = TRUE) # ensures that data is standardized - important to avoid bias in analysis

# summary of analysis
summary(full.dat.pca)


# elements of PCA object
names(full.dat.pca)
# 5 more elements provide additional analysis output

# standard dev of components
full.dat.pca$sdev

# eigenvectors = loadings per variable per vector component
full.dat.pca$rotation

# standard dev & mean of original variables
full.dat.pca$center
full.dat.pca$scale

# principal component scores for all 9 components
full.dat.pca$x



# VISUALIZE RESULTS

# scree plot of variance = shows explained variance per component - used to decide on optimal number of components to retain in analysis
fviz_eig(full.dat.pca, 
         addlabels = TRUE, # visualize variance percentages
         ylim = c(0, 40)) # to arrange limits of y axis

# biplot with default settings - interpret PCA results
fviz_pca_biplot(full.dat.pca)

# biplot with labeled variables = suppress data point labels
fviz_pca_biplot(full.dat.pca,
                label = "var")

# biplot with colored groups - color by a group = TP or site
fviz_pca_biplot(full.dat.pca,
                label = "var",
                habillage = wide.full.dat$Site)

fviz_pca_biplot(full.dat.pca,
                label = "var",
                habillage = wide.full.dat$TP)

# biplot with customized colored groups & variables
fviz_pca_biplot(full.dat.pca,
                label = "var",
                habillage = wide.full.dat$Site, 
                col.var = "black") +
  scale_color_manual(values = c("magenta", "orange", "steelblue"))

fviz_pca_biplot(full.dat.pca,
                label = "var",
                habillage = wide.full.dat$TP, 
                col.var = "black") +
  scale_color_manual(values = c("magenta", "orange", "steelblue"))


```

# CORRELATION MATRIX

Look for correlations between variables

```{r}
str(wide.full.dat)
res <- cor(wide.full.dat[,c(5:13)])
round(res, 2)
```
Interesting:
- Hard coral & macroalgae: -0.49 = when there's more coral there's less macroalgae
- Hard coral & benthic inverts: 0.37 = when there's more hard coral, there's more benthic inverts
- Macroalgae & hard coral: -0.49 = when there's more macroalgae there's less coral?

Not really any strong correlations for ascidians at all
-> highest one is ascidians & macroalgae with -0.1 = more ascidians, less macro & more macro, less ascidians?



